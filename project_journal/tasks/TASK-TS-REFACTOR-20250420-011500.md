# Task: TypeScript Project Refactoring & Optimization

**Goal:** å…¨é¢ä¼˜åŒ– TypeScript é¡¹ç›®ï¼Œå¢å¼ºç±»å‹å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŸºäº `project_journal/planning/stack_profile.md` çš„åˆ†æç»“æœã€‚

**Status:** âš ï¸ Completed (with unresolved test issues)

**Coordinator:** TASK-CMD-20250420-011500

**Assigned To:** typescript-specialist

**Acceptance Criteria:**

*   `[âœ…]` `tsconfig.json` é…ç½®äº†æœ€ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ (`strict: true`, `noImplicitAny: true`, `strictNullChecks: true`, `allowJs: false` ç­‰)ã€‚
*   `[âœ…]` ä»£ç ä¸­å°½å¯èƒ½æ¶ˆé™¤äº† `any` ç±»å‹ã€‚
*   `[âœ…]` æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ `src/tools/` ä¸‹çš„åŠŸèƒ½ï¼‰å…·æœ‰æ˜ç¡®ä¸”å®Œå–„çš„ç±»å‹å®šä¹‰ï¼ˆæ¥å£ã€æ³›å‹ã€æšä¸¾ç­‰ï¼‰ï¼Œç‰¹åˆ«å…³æ³¨ `src/types/yeepay.d.ts` çš„å®Œå–„ã€‚
*   `[âœ…]` æ‰€æœ‰å¿…è¦çš„ `@types` åŒ…å·²å®‰è£…ã€‚
*   `[âœ…]` `tsc` ç¼–è¯‘é€šè¿‡ï¼Œæ— ç±»å‹é”™è¯¯ã€‚
*   `[âŒ]` æ‰€æœ‰ç°æœ‰æµ‹è¯• (`npm test` æˆ–æ ¹æ® `package.json` ç¡®å®š) é€šè¿‡ã€‚ (Tests are currently failing due to ESM mocking issues)
*   `[âœ…]` æ„å»ºè„šæœ¬ (`package.json` scripts) å’Œ CI/CD é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å·²æ›´æ–°ä»¥é€‚åº” TypeScriptã€‚

**Context Files:**

*   `project_journal/planning/stack_profile.md`
*   `tsconfig.json`
*   `package.json`
*   `src/` ç›®å½•
*   `tests/` ç›®å½•

**Checklist:**

*   `[âœ…]` åˆ†æ `project_journal/planning/stack_profile.md` äº†è§£é¡¹ç›®æ¦‚å†µå’Œç°æœ‰é…ç½®ã€‚
*   `[âœ…]` æ£€æŸ¥å¹¶æ›´æ–° `tsconfig.json`ï¼Œå¯ç”¨æ‰€æœ‰æ¨èçš„ä¸¥æ ¼ç±»å‹æ£€æŸ¥é€‰é¡¹ï¼Œç¡®ä¿ `allowJs: false`ã€‚ ğŸ“£
*   `[âœ…]` æ£€æŸ¥ `package.json` ä¾èµ–ï¼Œè¿è¡Œ `npm install` å¹¶å®‰è£…ä»»ä½•ç¼ºå¤±çš„ `@types` åŒ…ã€‚ ğŸ“£
*   `[âœ…]` å®¡æŸ¥ `src/` ç›®å½•ä¸‹çš„ä»£ç ï¼Œè¯†åˆ«å¹¶æ¶ˆé™¤ `any` ç±»å‹ï¼Œä¼˜å…ˆå¤„ç† `src/tools/` å’Œ `src/index.ts`ã€‚
*   `[âœ…]` ä¸º `src/types/yeepay.d.ts` å’Œå…¶ä»–å¿…è¦çš„ä¸šåŠ¡é€»è¾‘åˆ›å»º/å®Œå–„æ¥å£ã€æ³›å‹ã€æšä¸¾ç­‰ç±»å‹å®šä¹‰ã€‚ (Cleaned up `yeepay.d.ts`, core types defined in `src/tools/`)
*   `[âœ…]` é‡æ„ä»£ç ä»¥åˆ©ç”¨ TypeScript é«˜çº§ç‰¹æ€§ï¼ˆå¦‚ `utility types`, `mapped types`, `conditional types` ç­‰ï¼‰ï¼Œæé«˜ä»£ç è´¨é‡ã€‚ (Used `as const` in `config.ts`)
*   `[âœ…]` è¿è¡Œ `tsc --noEmit` å‘½ä»¤ï¼Œç³»ç»Ÿæ€§åœ°è§£å†³æ‰€æœ‰æŠ¥å‘Šçš„ç±»å‹é”™è¯¯ã€‚ ğŸ“£
*   `[âŒ]` è¿è¡Œé¡¹ç›®æµ‹è¯•å¥—ä»¶ (æ‰§è¡Œ `package.json` ä¸­å®šä¹‰çš„æµ‹è¯•å‘½ä»¤ï¼Œå¯èƒ½æ˜¯ `npm test`)ï¼Œç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚ ğŸ“£ (Tests failed due to ESM mocking issues)
*   `[âœ…]` æ£€æŸ¥å¹¶æ ¹æ®éœ€è¦æ›´æ–° `package.json` ä¸­çš„æ„å»º (`build`) å’Œæµ‹è¯• (`test`) è„šæœ¬ã€‚
*   `[âœ…]` (å¦‚æœå­˜åœ¨ `.github/workflows` æˆ–ç±»ä¼¼ CI/CD é…ç½®) æ£€æŸ¥å¹¶æ›´æ–° CI/CD æµç¨‹ä»¥æ­£ç¡®æ‰§è¡Œ TypeScript ç¼–è¯‘å’Œæµ‹è¯•ã€‚
*   `[â³]` æäº¤æ‰€æœ‰ä»£ç å’Œé…ç½®æ›´æ”¹ã€‚ (Pending user/coordinator action)

---
**Summary:**

*   **`tsconfig.json`:** Enhanced for stricter type checking (`strict: true`, `noImplicitAny: true`, `strictNullChecks: true`, `allowJs: false`) and added path aliases (`@/*`).
*   **Dependencies:** Installed missing `@types` packages (`@types/axios`, `@types/crypto-js`, `@types/dotenv`).
*   **Type Safety:** Eliminated `any` types in `src/index.ts` using Zod schema inference. Refined types in `src/tools/` with specific interfaces and type assertions. Improved `src/config.ts` immutability using `as const`.
*   **Type Declarations:** Cleaned up `src/types/yeepay.d.ts`, removing redundant/incorrect declarations. Core business types remain defined within `src/tools/`.
*   **Compilation:** TypeScript compilation (`tsc --noEmit`) passed successfully.
*   **Scripts & CI/CD:** Checked `package.json` scripts (`build`, `test`) and GitHub Actions workflows (`npm-publish.yml`, `semantic-release.yml`); no changes were required.
*   **ğŸ”´ Unresolved Issue:** Integration tests (`npm test`) consistently fail with `TypeError: mockedCreatePayment.mockClear is not a function`. This indicates a persistent problem with Jest's ESM module mocking in the current configuration (ESM + TypeScript + Babel). Multiple standard mocking strategies (`jest.mock`, dynamic `import`, manual mocks, `spyOn`) and configuration adjustments (`jest.config.js`, `babel.config.cjs`) were attempted without resolving the issue. Further investigation or a different testing strategy (e.g., forcing CommonJS for tests) is required.

**References:**

*   `tsconfig.json` (modified)
*   `package.json` (modified - added devDependencies)
*   `src/index.ts` (modified)
*   `src/tools/createPayment.ts` (modified)
*   `src/tools/queryPayment.ts` (modified)
*   `src/config.ts` (modified)
*   `src/types/yeepay.d.ts` (modified)
*   `jest.config.js` (modified multiple times)
*   `babel.config.cjs` (modified)
*   `src/tools/__mocks__/createPayment.ts` (created)
*   `src/tools/__mocks__/queryPayment.ts` (created)
*   `tests/integration.test.ts` (modified multiple times)